<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§ÛŒÙ†Úˆ Ù¹Ùˆ Ø§ÛŒÙ†Úˆ Ø¢Ù Ù„Ø§Ø¦Ù† Ú†ÛŒÙ¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .sidebar {
            width: 300px;
            background: #34495e;
            color: white;
            padding: 20px;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .login-section {
            padding: 40px;
            text-align: center;
        }
        
        .login-section input {
            padding: 12px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 200px;
        }
        
        .login-section button {
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .user-list {
            margin-top: 20px;
        }
        
        .user-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            cursor: pointer;
        }
        
        .user-item:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .user-item.active {
            background: #27ae60;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .message.received {
            background: white;
            border: 1px solid #ddd;
            margin-right: auto;
        }
        
        .message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .message-header {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: white;
        }
        
        .input-area input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .encryption-status {
            background: #27ae60;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”’ Ø§ÛŒÙ†Úˆ Ù¹Ùˆ Ø§ÛŒÙ†Úˆ Ø§Ù†Ú©Ø±Ù¾Ù¹Úˆ Ú†ÛŒÙ¹</h1>
            <p>Ù…Ú©Ù…Ù„ Ø·ÙˆØ± Ù¾Ø± Ø¢Ù Ù„Ø§Ø¦Ù† Ø§ÙˆØ± Ù¾Ø±Ø§Ø¦ÛŒÙˆÛŒÙ¹ Ù…ÛŒØ³Ø¬Ù†Ú¯</p>
        </div>
        
        <div class="encryption-status" id="encryptionStatus">
            ğŸ” ØªÙ…Ø§Ù… Ù…ÛŒØ³Ø¬Ø² Ø§ÛŒÙ†Úˆ Ù¹Ùˆ Ø§ÛŒÙ†Úˆ Ø§Ù†Ú©Ø±Ù¾Ù¹Úˆ ÛÛŒÚº
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="login-section" id="loginSection">
                    <h3>Ø§Ù¾Ù†Ø§ Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº</h3>
                    <input type="text" id="usernameInput" placeholder="Ø¢Ù¾ Ú©Ø§ Ù†Ø§Ù…">
                    <button onclick="registerUser()">Ø´Ø±ÙˆØ¹ Ú©Ø±ÛŒÚº</button>
                </div>
                
                <div class="user-list hidden" id="userListSection">
                    <h3>Ø¢Ù† Ù„Ø§Ø¦Ù† ÛŒÙˆØ²Ø±Ø²</h3>
                    <div id="userList"></div>
                </div>
            </div>
            
            <div class="chat-area hidden" id="chatArea">
                <div class="messages" id="messages"></div>
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="Ø§Ù¾Ù†Ø§ Ù…ÛŒØ³Ø¬ Ù„Ú©Ú¾ÛŒÚº..." onkeypress="handleKeyPress(event)">
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io();
        let currentUser = null;
        let selectedUser = null;

        // ÛŒÙˆØ²Ø± Ø±Ø¬Ø³Ù¹Ø± Ú©Ø±ÛŒÚº
        function registerUser() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return;
            
            socket.emit('register', username);
        }

        // Ø³Ø±ÙˆØ± Ø³Û’ Ø¬ÙˆØ§Ø¨
        socket.on('registered', (data) => {
            currentUser = data;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userListSection').classList.remove('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
        });

        // ÛŒÙˆØ²Ø± Ù„Ø³Ù¹ Ø§Ù¾ÚˆÛŒÙ¹
        socket.on('user_list', (users) => {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            users.forEach(user => {
                if (user.id !== socket.id) {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.textContent = user.username;
                    userElement.onclick = () => selectUser(user);
                    userList.appendChild(userElement);
                }
            });
        });

        // ÛŒÙˆØ²Ø± Ø³Ù„ÛŒÚ©Ù¹ Ú©Ø±ÛŒÚº
        function selectUser(user) {
            selectedUser = user;
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Ù…ÛŒØ³Ø¬ Ø¨Ú¾ÛŒØ¬ÛŒÚº
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !selectedUser) return;
            
            socket.emit('send_message', {
                to: selectedUser.id,
                message: message
            });
            
            // Ù„ÙˆÚ©Ù„ ÚˆØ³Ù¾Ù„Û’
            displayMessage({
                from: currentUser.userId,
                fromUsername: 'Ø¢Ù¾',
                encryptedMessage: { encrypted: 'Ø§Ù†Ú©Ø±Ù¾Ù¹Úˆ Ù…ÛŒØ³Ø¬' },
                timestamp: Date.now()
            }, 'sent');
            
            messageInput.value = '';
        }

        // Ù…ÛŒØ³Ø¬ ÙˆØµÙˆÙ„ Ú©Ø±ÛŒÚº
        socket.on('receive_message', (data) => {
            displayMessage(data, 'received');
            
            // Ø¢Ù¹Ùˆ ÚˆÛŒÚ©Ø±Ù¾Ù¹
            socket.emit('decrypt_message', {
                encryptedMessage: data.encryptedMessage
            });
        });

// ÚˆÛŒÚ©Ø±Ù¾Ù¹Úˆ Ù…ÛŒØ³Ø¬
        socket.on('message_decrypted', (data) => {
            const messagesDiv = document.getElementById('messages');
            const lastMessage = messagesDiv.lastChild;
            
            if (lastMessage && lastMessage.dataset.encrypted === data.original.encrypted) {
                lastMessage.querySelector('.message-text').textContent = data.decrypted;
            }
        });

        // Ù…ÛŒØ³Ø¬ ÚˆØ³Ù¾Ù„Û’ Ú©Ø±ÛŒÚº
        function displayMessage(data, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = message ${type};
            messageDiv.dataset.encrypted = data.encryptedMessage.encrypted;
            
            const time = new Date(data.timestamp).toLocaleTimeString();
            
            messageDiv.innerHTML = 
                <div class="message-header">${data.fromUsername} â€¢ ${time}</div>
                <div class="message-text">
                    ${type === 'sent' ? data.encryptedMessage.encrypted : 'ğŸ”’ Ø§Ù†Ú©Ø±Ù¾Ù¹Úˆ Ù…ÛŒØ³Ø¬...'}
                </div>
            ;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Ú©ÛŒ Ù¾Ø±ÛŒØ³ Ø§ÛŒÙˆÙ†Ù¹
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Ù†ÛŒØ§ ÛŒÙˆØ²Ø± Ø¬ÙˆØ§Ø¦Ù†
        socket.on('user_joined', (data) => {
            addUserToList(data);
        });

        // ÛŒÙˆØ²Ø± Ù„ÛŒÙÙ¹
        socket.on('user_left', (data) => {
            removeUserFromList(data.userId);
        });

        function addUserToList(user) {
            const userList = document.getElementById('userList');
            const userElement = document.createElement('div');
            userElement.className = 'user-item';
            userElement.textContent = user.username;
            userElement.onclick = () => selectUser(user);
            userElement.dataset.userId = user.userId;
            userList.appendChild(userElement);
        }

        function removeUserFromList(userId) {
            const userElement = document.querySelector([data-user-id="${userId}"]);
            if (userElement) {
                userElement.remove();
            }
        }
    </script>
</body>
</html>

const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const crypto = require('crypto');
const path = require('path');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());

// ÛŒÙˆØ²Ø± Ø³Ù¹ÙˆØ± (Ø¹Ù…Ù„ÛŒ Ø·ÙˆØ± Ù¾Ø± ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚº)
const users = new Map();
const messages = new Map();

// Encryption keys Ú©Û’ Ù„ÛŒÛ’
const generateKeyPair = () => {
    const privateKey = crypto.randomBytes(32);
    const publicKey = crypto.randomBytes(32);
    return { privateKey, publicKey };
};

// Ù…ÛŒØ³Ø¬ Ø§Ù†Ú©Ø±Ù¾Ø´Ù†
const encryptMessage = (message, publicKey) => {
    const algorithm = 'aes-256-gcm';
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(algorithm, publicKey);
    
    let encrypted = cipher.update(message, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return {
        iv: iv.toString('hex'),
        encrypted: encrypted,
        authTag: authTag.toString('hex'),
        timestamp: Date.now()
    };
};

// Ù…ÛŒØ³Ø¬ ÚˆÛŒÚ©Ø±Ù¾Ø´Ù†
const decryptMessage = (encryptedData, privateKey) => {
    const algorithm = 'aes-256-gcm';
    const decipher = crypto.createDecipher(algorithm, privateKey);
    
    decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'));
    
    let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
};

// Socket.io connections
io.on('connection', (socket) => {
    console.log('Ù†ÛŒØ§ ÛŒÙˆØ²Ø± Ú©Ù†ÛŒÚ©Ù¹ ÛÙˆØ§:', socket.id);

    // Ù†ÛŒØ§ ÛŒÙˆØ²Ø± Ø±Ø¬Ø³Ù¹Ø± Ú©Ø±ÛŒÚº
    socket.on('register', (username) => {
        const keyPair = generateKeyPair();
        const user = {
            id: socket.id,
            username,
            publicKey: keyPair.publicKey.toString('hex'),
            privateKey: keyPair.privateKey.toString('hex'),
            socketId: socket.id
        };
        
        users.set(socket.id, user);
        socket.emit('registered', {
            userId: socket.id,
            publicKey: user.publicKey
        });
        
        // Ø¯ÙˆØ³Ø±Û’ ÛŒÙˆØ²Ø±Ø² Ú©Ùˆ Ù†ÛŒØ§ ÛŒÙˆØ²Ø± Ø¨ØªØ§Ø¦ÛŒÚº
        socket.broadcast.emit('user_joined', {
            userId: socket.id,
            username: username,
            publicKey: user.publicKey
        });
        
        // Ù…ÙˆØ¬ÙˆØ¯Û ÛŒÙˆØ²Ø±Ø² Ú©ÛŒ Ù„Ø³Ù¹ Ø¨Ú¾ÛŒØ¬ÛŒÚº
        const userList = Array.from(users.values()).map(u => ({
            id: u.id,
            username: u.username,
            publicKey: u.publicKey
        }));
        socket.emit('user_list', userList);
    });

    // Ù…ÛŒØ³Ø¬ Ø¨Ú¾ÛŒØ¬ÛŒÚº
    socket.on('send_message', (data) => {
        const { to, message } = data;
        const fromUser = users.get(socket.id);
        const toUser = users.get(to);
        
        if (!fromUser || !toUser) return;
        
        // Ù…ÛŒØ³Ø¬ Ø§Ù†Ú©Ø±Ù¾Ù¹ Ú©Ø±ÛŒÚº
        const encryptedMessage = encryptMessage(
            message, 
            Buffer.from(toUser.publicKey, 'hex')
        );
        
        const messageData = {
            id: crypto.randomBytes(16).toString('hex'),
            from: socket.id,
            to: to,
            fromUsername: fromUser.username,
            encryptedMessage: encryptedMessage,
            timestamp: Date.now()
        };
        
        // Ù…ÛŒØ³Ø¬ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº
        if (!messages.has(socket.id)) {
            messages.set(socket.id, []);
        }
        messages.get(socket.id).push(messageData);
        
        // Ø±Ø³ÛŒÙˆØ± Ú©Ùˆ Ù…ÛŒØ³Ø¬ Ø¨Ú¾ÛŒØ¬ÛŒÚº
        socket.to(to).emit('receive_message', {
            ...messageData,
            encryptedMessage: encryptedMessage
        });
        
        // Ø³ÛŒÙ†ÚˆØ± Ú©Ùˆ Ú©Ù†ÙØ±Ù…ÛŒØ´Ù† Ø¨Ú¾ÛŒØ¬ÛŒÚº
        socket.emit('message_sent', {
            messageId: messageData.id,
            to: toUser.username
        });
    });

// Ù…ÛŒØ³Ø¬ ÚˆÛŒÚ©Ø±Ù¾Ù¹ Ú©Ø±ÛŒÚº
    socket.on('decrypt_message', (data) => {
        const { encryptedMessage } = data;
        const user = users.get(socket.id);
        
        if (!user) return;
        
        try {
            const decrypted = decryptMessage(
                encryptedMessage,
                Buffer.from(user.privateKey, 'hex')
            );
            
            socket.emit('message_decrypted', {
                original: encryptedMessage,
                decrypted: decrypted
            });
        } catch (error) {
            socket.emit('decryption_error', {
                error: 'ÚˆÛŒÚ©Ø±Ù¾Ø´Ù† Ù†Ø§Ú©Ø§Ù…'
            });
        }
    });

    // ÚˆØ³ Ú©Ù†ÛŒÚ©Ù¹
    socket.on('disconnect', () => {
        const user = users.get(socket.id);
        if (user) {
            socket.broadcast.emit('user_left', {
                userId: socket.id,
                username: user.username
            });
            users.delete(socket.id);
        }
        console.log('ÛŒÙˆØ²Ø± ÚˆØ³ Ú©Ù†ÛŒÚ©Ù¹ ÛÙˆØ§:', socket.id);
    });
});

// HTTP routes
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.get('/api/users', (req, res) => {
    const userList = Array.from(users.values()).map(u => ({
        id: u.id,
        username: u.username
    }));
    res.json(userList);
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(Ø³Ø±ÙˆØ± Ù¾ÙˆØ±Ù¹ ${PORT} Ù¾Ø± Ú†Ù„ Ø±ÛØ§ ÛÛ’);
    console.log(http://localhost:${PORT} Ù¾Ø± Ø¬Ø§Ø¦ÛŒÚº);
});

{
  "name": "e2e-offline-chat",
  "version": "1.0.0",
  "description": "End-to-End Encrypted Offline Chat System",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "socket.io": "^4.7.2",
    "crypto": "^1.0.1",
    "uuid": "^9.0.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
